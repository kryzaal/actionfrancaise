<% include head %>

<% include slideshow %>

<div id="alaune"> 
    <div id="evenement"></div>
       
    <div class="video videodumoment" id="video_e5WxM2qjpBo" onClick="loadVideo(this, 'e5WxM2qjpBo')"></div>
    <script>$('document').ready(function() {loadTitle('e5WxM2qjpBo');});</script>
    <div id="videossecondaires">
        <div class="video" id="video_1jPOX72PPMw" onClick="loadVideo(this, '1jPOX72PPMw')"></div>
        <script>$('document').ready(function() {loadTitle('1jPOX72PPMw');});</script>
        <div class="video" id="video_5W-IIoqQHKs" onClick="loadVideo(this, '5W-IIoqQHKs')"></div>
        <script>$('document').ready(function() {loadTitle('5W-IIoqQHKs');});</script>
    </div>
</div> 

<div id="filtre_articles">
    <input type="text" id="search" placeholder="Mot clÃ©, auteur, titre ..." auto/>
</div>

<div id="articles"></div>

<script>
    function loadVideo(parentDiv, code) {
        parentDiv.innerHTML = '<iframe src="http://www.youtube.com/embed/' + code + '?rel=0&autoplay=1" frameborder="0" allowfullscreen></iframe>';
    }

    function loadTitle(code) {
        $.getJSON("http://gdata.youtube.com/feeds/api/videos/" + code + "?v=2&alt=jsonc", function(response) {
            document.getElementById("video_" + code).innerHTML = '<img src="http://img.youtube.com/vi/' + code + '/0.jpg"/>' + '<h1>' + response.data.title + '</h1>';
        });
    }

    var cache_resume = {};

    function load_one(article_node, html) {
        $(article_node).html(html);
        $(article_node).find('.texte_article p').each(function() {
            var jElement = $(this);

            while(jElement[0].scrollHeight > jElement[0].offsetHeight) {
                var lastIndex = jElement.html().lastIndexOf(" ");
                jElement.html(jElement.html().substring(0, lastIndex) + '&hellip;');
            }
        });
    }

    function load_list(list) {
        $("#articles").empty();
        list.forEach(function(code) {
            $("#articles").append('<div class="article" data-code="' + code + '"></div>');
        });

        $("#articles div.article").each(function() {
            var article_element = this;
            var code = this.dataset.code;
            if(typeof(cache_resume[code]) === 'undefined') $.get('/articles/' + code + '/resume', function(html) {
                cache_resume[code] = html;
                load_one(article_element, html);
            }); else load_one(article_element, cache_resume[code]);
        });
    }

    $(function() {
        $.get('/actions/latest', function(data) {
            $("#evenement").html(
                '<a href="/actions/' + data.code + '">' +
                    '<img class="image_evenement" src="/actions/' + data.code + '/affiche" />' +
                    '<h1>' + data.code + '</h1>' +
                '</a>');
        });

        $("#search").val("").keyup(function() {
            $.post('/articles/' + $(this).val(), load_list);
        });

        $.get('/articles', load_list);
    });
</script>
<% include foot %>